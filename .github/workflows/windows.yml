name: rdp-windows

on:
  workflow_dispatch:
  push:

jobs:
  rdp:
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
    steps:
      - name: Clone repo
        run: gh repo clone $GITHUB_REPOSITORY . -- --depth 1 --branch ${GITHUB_REF#refs/heads/}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    
      - name: Expand uvnc
        run:  Expand-Archive .\tools\uvnc.zip
        
      - name: Set config  
        run: Move-Item .\scripts\UltraVNC.ini .\uvnc\64 
      
      - name: Set Resolution
        run: .\scripts\Set-ScreenResolution.ps1
      - name: Set scale
        run: .\scripts\Set-Scale.ps1 1
      - name: Set ColorTheme
        run: Set-ItemProperty -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize -Name AppsUseLightTheme -Value 0
      - name: Start Vnc
        run: start .\uvnc\64\winvnc.exe
      - name: Enable TS
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
      - run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      - run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
      - run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
      - run: Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
      - name: Start piping
        run: .\tools\piping.exe server -p 5900 fkunn1326 fkunn1327
